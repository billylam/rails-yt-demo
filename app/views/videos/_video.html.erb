<div id="player"> </div>

<script>
  var currentlyPlaying = 0;
  var idList = [<%= raw playlist.videos.pluck(:youtube_id).to_json if defined? playlist %>];

  //Load IFrame YouTube API
  var tag = document.createElement('script');

  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  //Construct Player
  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '315',
      width: '560',
      <% if defined? playlist %>
        playerVars: {'playlist':idList},
      <% else %>
        videoId: '<%= video.youtube_id %>', 
      <% end %>
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  //Functionality
  var reload=false;
  function onPlayerReady(event) {
  }

  function onPlayerStateChange(event) {
    //if a player is unstarted, we should refresh the playlist if necessary

    //investigate if chaging from yt player also puts it into unstarted state

    //we should highlight the currently playing video
  }

  function changeVideo(position) {
    player.playVideoAt(position);
  }

  function highlight(position) {

  }

  function queueReloadPlaylist() {
    reload = true;
  }

  function reloadPlaylist(position) {
    reload = false;
    idList = <%= raw playlist.videos.pluck(:youtube_id).to_json if defined? playlist %>;
    player.loadPlaylist(idList);
  }

</script>
