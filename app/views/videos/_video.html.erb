<div id="player"> </div>

<script>
  var currentlyPlaying = 0;
  <% if defined? playlist %>
    var idList = <%= raw playlist.videos.pluck(:youtube_id).to_json %>;
  <% else %>
    var idList = [];
  <% end %>

  //Load IFrame YouTube API
  var tag = document.createElement('script');

  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  //Construct Player
  var player;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '315',
      width: '560',
      playerVars: {'playlist':[idList]},
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  //Functionality
  var reload=false;
  function onPlayerReady(event) {
  }

  function onPlayerStateChange(event) {
    if (reload && reload == true && event.data == YT.PlayerState.UNSTARTED) {
      current = player.getPlaylistIndex();  
      reloadPlaylist(current);
    }
  }

  function changeVideo(position) {
    player.playVideoAt(position);
  }

  function highlight(position) {

  }

  function queueReloadPlaylist(youtube_id) {
    idList.push(youtube_id)
    reload = true;
  }

  function reloadPlaylist(position) {
    reload = false;
    player.loadPlaylist(idList, position);
  }

</script>
